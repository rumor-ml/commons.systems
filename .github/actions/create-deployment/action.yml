name: 'Create GitHub Deployment'
description: 'Creates a GitHub deployment with status updates'
inputs:
  environment:
    description: 'Deployment environment name'
    required: true
  environment_url:
    description: 'URL of the deployment'
    required: true
  site_name:
    description: 'Name of the site being deployed'
    required: true
  is_preview:
    description: 'Whether this is a preview deployment'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: Create deployment and set status
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
        SITE_NAME: ${{ inputs.site_name }}
        ENVIRONMENT: ${{ inputs.environment }}
      run: |
        set -euo pipefail

        DEPLOYMENT_RESPONSE=$(gh api repos/${{ github.repository }}/deployments \
          -X POST \
          -f ref="${{ github.sha }}" \
          -f environment="${ENVIRONMENT}" \
          -f description="Deploy ${SITE_NAME} to ${ENVIRONMENT}" \
          -F auto_merge=false \
          ${{ inputs.is_preview == 'true' && '-F transient_environment=true' || '' }})

        DEPLOYMENT_ID=$(echo "$DEPLOYMENT_RESPONSE" | jq -r '.id')

        if [ "$DEPLOYMENT_ID" = "null" ] || [ -z "$DEPLOYMENT_ID" ]; then
          echo "::error::Failed to create deployment"
          echo "$DEPLOYMENT_RESPONSE"
          exit 1
        fi

        gh api repos/${{ github.repository }}/deployments/$DEPLOYMENT_ID/statuses \
          -X POST \
          -f state="success" \
          -f environment_url="${{ inputs.environment_url }}" \
          -f log_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          -f description="Deployment successful"
