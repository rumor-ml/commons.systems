name: Initialize Infrastructure

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'GCP Project ID'
        required: true
        type: string
      region:
        description: 'GCP Region'
        required: false
        default: 'us-central1'
        type: string
      create_secrets:
        description: 'Automatically create GitHub secrets (requires gh CLI auth)'
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  secrets: write  # Required for creating GitHub secrets

env:
  GCP_PROJECT_ID: ${{ inputs.project_id }}
  GCP_REGION: ${{ inputs.region }}

jobs:
  initialize:
    name: Initialize GCP Infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Nix cache
        uses: cachix/cachix-action@v14
        with:
          name: fellspiral
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS_JSON }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify GCP authentication
        run: |
          gcloud config set project "$GCP_PROJECT_ID"
          gcloud auth list
          echo "‚úÖ Authenticated to GCP project: $GCP_PROJECT_ID"

      - name: Enable required GCP APIs
        run: |
          nix develop .#ci --command bash -c '
            echo "Enabling required GCP APIs..."
            gcloud services enable \
              iam.googleapis.com \
              iamcredentials.googleapis.com \
              cloudresourcemanager.googleapis.com \
              sts.googleapis.com \
              --project="$GCP_PROJECT_ID"

            echo "‚úÖ APIs enabled"
          '

      - name: Create Workload Identity Pool
        id: create-pool
        run: |
          nix develop .#ci --command bash -c '
            POOL_NAME="github-actions-pool"

            # Check if pool exists
            if gcloud iam workload-identity-pools describe "$POOL_NAME" \
                --location="global" \
                --project="$GCP_PROJECT_ID" 2>/dev/null; then
              echo "Workload Identity Pool already exists"
            else
              echo "Creating Workload Identity Pool..."
              gcloud iam workload-identity-pools create "$POOL_NAME" \
                --location="global" \
                --display-name="GitHub Actions Pool" \
                --project="$GCP_PROJECT_ID"
              echo "‚úÖ Workload Identity Pool created"
            fi

            POOL_ID="projects/$GCP_PROJECT_ID/locations/global/workloadIdentityPools/$POOL_NAME"
            echo "POOL_ID=$POOL_ID" >> $GITHUB_OUTPUT
          '

      - name: Create Workload Identity Provider
        id: create-provider
        run: |
          nix develop .#ci --command bash -c '
            POOL_NAME="github-actions-pool"
            PROVIDER_NAME="github-provider"
            REPO_OWNER="${{ github.repository_owner }}"
            REPO_NAME="${{ github.event.repository.name }}"

            # Check if provider exists
            if gcloud iam workload-identity-pools providers describe "$PROVIDER_NAME" \
                --workload-identity-pool="$POOL_NAME" \
                --location="global" \
                --project="$GCP_PROJECT_ID" 2>/dev/null; then
              echo "Workload Identity Provider already exists"
            else
              echo "Creating Workload Identity Provider..."
              gcloud iam workload-identity-pools providers create-oidc "$PROVIDER_NAME" \
                --workload-identity-pool="$POOL_NAME" \
                --location="global" \
                --issuer-uri="https://token.actions.githubusercontent.com" \
                --attribute-mapping="google.subject=assertion.sub,attribute.actor=assertion.actor,attribute.repository=assertion.repository" \
                --attribute-condition="assertion.repository_owner==\"$REPO_OWNER\"" \
                --project="$GCP_PROJECT_ID"
              echo "‚úÖ Workload Identity Provider created"
            fi

            PROVIDER_ID="projects/$GCP_PROJECT_ID/locations/global/workloadIdentityPools/$POOL_NAME/providers/$PROVIDER_NAME"
            echo "PROVIDER_ID=$PROVIDER_ID" >> $GITHUB_OUTPUT
          '

      - name: Create Service Account
        id: create-sa
        run: |
          nix develop .#ci --command bash -c '
            SA_NAME="github-actions-terraform"
            SA_EMAIL="${SA_NAME}@${GCP_PROJECT_ID}.iam.gserviceaccount.com"

            # Check if service account exists
            if gcloud iam service-accounts describe "$SA_EMAIL" \
                --project="$GCP_PROJECT_ID" 2>/dev/null; then
              echo "Service account already exists"
            else
              echo "Creating service account..."
              gcloud iam service-accounts create "$SA_NAME" \
                --display-name="GitHub Actions Terraform" \
                --description="Service account for GitHub Actions to manage infrastructure via Terraform" \
                --project="$GCP_PROJECT_ID"
              echo "‚úÖ Service account created"
            fi

            echo "SA_EMAIL=$SA_EMAIL" >> $GITHUB_OUTPUT
          '

      - name: Grant IAM permissions
        run: |
          nix develop .#ci --command bash -c '
            SA_EMAIL="${{ steps.create-sa.outputs.SA_EMAIL }}"

            echo "Granting IAM permissions..."

            # Grant necessary roles
            for ROLE in \
              "roles/iam.serviceAccountAdmin" \
              "roles/iam.workloadIdentityPoolAdmin" \
              "roles/resourcemanager.projectIamAdmin" \
              "roles/storage.admin" \
              "roles/compute.admin"; do

              gcloud projects add-iam-policy-binding "$GCP_PROJECT_ID" \
                --member="serviceAccount:$SA_EMAIL" \
                --role="$ROLE" \
                --condition=None \
                --project="$GCP_PROJECT_ID"
            done

            echo "‚úÖ IAM permissions granted"
          '

      - name: Bind Workload Identity
        run: |
          nix develop .#ci --command bash -c '
            POOL_NAME="github-actions-pool"
            SA_EMAIL="${{ steps.create-sa.outputs.SA_EMAIL }}"
            REPO_OWNER="${{ github.repository_owner }}"
            REPO_NAME="${{ github.event.repository.name }}"

            echo "Binding Workload Identity..."

            gcloud iam service-accounts add-iam-policy-binding "$SA_EMAIL" \
              --role="roles/iam.workloadIdentityUser" \
              --member="principalSet://iam.googleapis.com/projects/$GCP_PROJECT_ID/locations/global/workloadIdentityPools/$POOL_NAME/attribute.repository/$REPO_OWNER/$REPO_NAME" \
              --project="$GCP_PROJECT_ID"

            echo "‚úÖ Workload Identity binding complete"
          '

      - name: Create GitHub Secrets
        if: inputs.create_secrets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          nix develop .#ci --command bash -c '
            PROVIDER_ID="${{ steps.create-provider.outputs.PROVIDER_ID }}"
            SA_EMAIL="${{ steps.create-sa.outputs.SA_EMAIL }}"

            echo "Creating GitHub secrets..."

            # Create secrets using GitHub CLI
            echo "$GCP_PROJECT_ID" | gh secret set GCP_PROJECT_ID
            echo "$PROVIDER_ID" | gh secret set GCP_WORKLOAD_IDENTITY_PROVIDER
            echo "$SA_EMAIL" | gh secret set GCP_SERVICE_ACCOUNT

            echo "‚úÖ GitHub secrets created"
          '

      - name: Summary
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## Infrastructure Initialization Complete! üöÄ

          ### Resources Created

          **GCP Project:** \`$GCP_PROJECT_ID\`
          **Region:** \`$GCP_REGION\`

          **Workload Identity Pool:** \`github-actions-pool\`
          **Workload Identity Provider:** \`${{ steps.create-provider.outputs.PROVIDER_ID }}\`
          **Service Account:** \`${{ steps.create-sa.outputs.SA_EMAIL }}\`

          ### GitHub Secrets

          The following secrets have been created:
          - ‚úÖ \`GCP_PROJECT_ID\`
          - ‚úÖ \`GCP_WORKLOAD_IDENTITY_PROVIDER\`
          - ‚úÖ \`GCP_SERVICE_ACCOUNT\`

          ### Next Steps

          1. **Terraform will run automatically** on the next push to main
          2. **Infrastructure will be created:**
             - Cloud Storage buckets
             - Cloud CDN
             - Load Balancer
             - Static IP
          3. **Deployments will work automatically** on every merge to main

          ### Security

          - ‚úÖ No service account keys created
          - ‚úÖ Keyless authentication via Workload Identity Federation
          - ‚úÖ Short-lived tokens only
          - ‚úÖ No key rotation needed

          **Your infrastructure is now fully automated!**
          EOF

      - name: Notify on Failure
        if: failure()
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## Infrastructure Initialization Failed ‚ùå

          Check the workflow logs for details.

          **Common issues:**
          - Missing GCP_CREDENTIALS_JSON secret
          - Insufficient permissions in GCP project
          - APIs not enabled
          - Invalid project ID

          **Manual fallback:**
          Run the setup script locally:
          \`\`\`bash
          cd infrastructure/scripts
          ./setup-workload-identity.sh
          \`\`\`
          EOF
