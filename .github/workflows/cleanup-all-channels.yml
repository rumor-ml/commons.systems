name: Cleanup All Firebase Preview Channels

on:
  workflow_dispatch:

env:
  GCP_PROJECT_ID: chalanding
  GCP_REGION: us-central1

jobs:
  cleanup-all:
    name: Delete All Preview Channels
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/190604485916/locations/global/workloadIdentityPools/github-actions/providers/github'
          service_account: 'github-actions-terraform@chalanding.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Firebase CLI
        run: pnpm add -g firebase-tools

      - name: List and delete all preview channels
        env:
          PROJECT: ${{ env.GCP_PROJECT_ID }}
        run: |
          SITES=("fellspiral" "videobrowser" "audiobrowser" "print")

          echo "========================================="
          echo "Firebase Hosting Channel Cleanup Report"
          echo "========================================="
          echo ""

          TOTAL_DELETED=0

          for site in "${SITES[@]}"; do
            echo "=== Site: ${site} ==="
            echo ""

            # List all channels for this site
            echo "üìã Listing all channels..."
            CHANNELS=$(firebase hosting:channel:list --site ${site} --project ${PROJECT} --json 2>/dev/null || echo "[]")

            # Parse channel names from JSON
            CHANNEL_NAMES=$(echo "$CHANNELS" | jq -r '.[].name // empty' 2>/dev/null || echo "")

            if [ -z "$CHANNEL_NAMES" ]; then
              echo "‚ÑπÔ∏è  No channels found or unable to list"
              echo ""
              continue
            fi

            CHANNEL_COUNT=$(echo "$CHANNEL_NAMES" | wc -l | tr -d ' ')
            echo "Found ${CHANNEL_COUNT} channels"
            echo ""

            # Delete each channel
            SITE_DELETED=0
            while IFS= read -r channel; do
              if [ -n "$channel" ]; then
                echo "üóëÔ∏è  Deleting channel: ${channel}"
                if firebase hosting:channel:delete "$channel" \
                  --site ${site} \
                  --project ${PROJECT} \
                  --force 2>&1; then
                  echo "   ‚úÖ Deleted successfully"
                  TOTAL_DELETED=$((TOTAL_DELETED + 1))
                  SITE_DELETED=$((SITE_DELETED + 1))
                else
                  echo "   ‚ö†Ô∏è  Failed to delete"
                fi
              fi
            done <<< "$CHANNEL_NAMES"

            echo "Deleted ${SITE_DELETED} channels from ${site}"
            echo ""
          done

          echo "========================================="
          echo "Cleanup Summary"
          echo "========================================="
          echo "Total channels deleted across all sites: ${TOTAL_DELETED}"
          echo ""

          # Write to step summary
          echo "### üßπ Complete Channel Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total channels deleted:** ${TOTAL_DELETED}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Firebase Hosting preview channels have been cleaned up across:" >> $GITHUB_STEP_SUMMARY
          echo "- fellspiral" >> $GITHUB_STEP_SUMMARY
          echo "- videobrowser" >> $GITHUB_STEP_SUMMARY
          echo "- audiobrowser" >> $GITHUB_STEP_SUMMARY
          echo "- print" >> $GITHUB_STEP_SUMMARY
