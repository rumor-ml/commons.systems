name: CI - Test Suite

on:
  workflow_run:
    workflows: ["Deploy Feature Branch Preview"]
    types:
      - completed
    branches-ignore:
      - main
  push:
    branches: ['**']

jobs:
  test:
    name: Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build site
        run: npm run build --workspace=fellspiral/site

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Determine deployment URL
        id: deployment-url
        run: |
          if [ "${{ github.ref_name }}" == "main" ]; then
            # Main branch tests the production deployment
            SITE_URL="https://fellspiral.commons.systems"
            echo "Testing main branch against production: $SITE_URL"
          else
            # Feature branch - get the preview deployment URL
            BRANCH_NAME="${{ github.ref_name }}"
            BRANCH_NAME="${BRANCH_NAME#claude/}"
            SANITIZED=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | tr '/_' '-' | sed 's/[^a-z0-9-]//g')
            SERVICE_NAME="fb-${SANITIZED}"
            SERVICE_NAME="${SERVICE_NAME:0:63}"
            SERVICE_NAME="${SERVICE_NAME%-}"

            echo "Looking for feature branch service: $SERVICE_NAME"

            SITE_URL=$(gcloud run services describe "$SERVICE_NAME" \
              --region=us-central1 \
              --format='value(status.url)' 2>/dev/null || echo "")

            if [ -z "$SITE_URL" ]; then
              echo "❌ Could not find feature branch deployment: $SERVICE_NAME"
              exit 1
            fi

            echo "Testing feature branch against preview: $SITE_URL"
          fi

          echo "url=${SITE_URL}" >> $GITHUB_OUTPUT
          echo "Site URL: ${SITE_URL}"

      - name: Wait for site to be ready
        run: |
          SITE_URL="${{ steps.deployment-url.outputs.url }}"
          echo "Waiting for site to be ready: $SITE_URL"

          # Wait up to 5 minutes for feature branch deployments
          MAX_ATTEMPTS=60
          for i in $(seq 1 $MAX_ATTEMPTS); do
            if curl -sf "$SITE_URL" > /dev/null 2>&1; then
              echo "✅ Site is ready after $((i*5)) seconds!"
              break
            fi
            echo "Waiting for site... ($i/$MAX_ATTEMPTS)"
            sleep 5
          done

          # Final check
          if ! curl -sf "$SITE_URL" > /dev/null 2>&1; then
            echo "❌ Site is not responding after $((MAX_ATTEMPTS*5)) seconds"
            exit 1
          fi

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        run: npx playwright test --project=chromium --workers=4
        working-directory: fellspiral/tests
        env:
          DEPLOYED: 'true'
          DEPLOYED_URL: ${{ steps.deployment-url.outputs.url }}
          CI: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: fellspiral/tests/playwright-report/
          retention-days: 30

  lint:
    name: Lint Check
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for console.log in source
        run: |
          echo "Checking for console.log in source files..."
          if grep -r "console\.log" fellspiral/site/src/ 2>/dev/null; then
            echo "❌ Found console.log statements in source code"
            exit 1
          else
            echo "✅ No console.log statements found"
          fi

      - name: Check for TODO comments
        run: |
          echo "Checking for TODO/FIXME comments..."
          if grep -r "TODO\|FIXME" fellspiral/ 2>/dev/null; then
            echo "ℹ️ Found TODO/FIXME comments (informational only)"
          else
            echo "✅ No TODO/FIXME comments found"
          fi
