name: CI - Test Suite

on:
  push:
    branches: ['**']

jobs:
  test:
    name: Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build site
        run: npm run build --workspace=fellspiral/site

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Playwright server URL
        id: playwright-server
        run: |
          SERVICE_URL=$(gcloud run services describe playwright-server \
            --platform managed \
            --region us-central1 \
            --format 'value(status.url)')
          echo "url=${SERVICE_URL}" >> $GITHUB_OUTPUT
          echo "Playwright Server URL: ${SERVICE_URL}"

      - name: Test server health
        run: |
          echo "Testing Playwright server health..."
          curl -f ${{ steps.playwright-server.outputs.url }}/health || {
            echo "❌ Playwright server is not responding"
            exit 1
          }
          echo "✅ Playwright server is healthy"

      - name: Run tests via remote Playwright server
        run: |
          cd playwright-server
          node run-tests.js --project chromium --workers 4 --deployed
        env:
          PLAYWRIGHT_SERVER_URL: ${{ steps.playwright-server.outputs.url }}
          CI: true

      # Note: Test reports are stored on the Playwright server
      # and printed to the console output. They can be accessed
      # via the server's /api/reports/{id} endpoint if needed.

  lint:
    name: Lint Check
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for console.log in source
        run: |
          echo "Checking for console.log in source files..."
          if grep -r "console\.log" fellspiral/site/src/ 2>/dev/null; then
            echo "❌ Found console.log statements in source code"
            exit 1
          else
            echo "✅ No console.log statements found"
          fi

      - name: Check for TODO comments
        run: |
          echo "Checking for TODO/FIXME comments..."
          if grep -r "TODO\|FIXME" fellspiral/ 2>/dev/null; then
            echo "ℹ️ Found TODO/FIXME comments (informational only)"
          else
            echo "✅ No TODO/FIXME comments found"
          fi
