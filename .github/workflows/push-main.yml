name: Main/PR Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches: ['**']
  workflow_dispatch:

# Only allow one pipeline per ref at a time
concurrency:
  group: push-main-${{ github.ref }}
  cancel-in-progress: true

env:
  GCP_PROJECT_ID: chalanding
  GCP_REGION: us-central1

permissions:
  contents: write
  id-token: write
  pull-requests: write
  issues: write
  actions: read
  packages: read

jobs:
  # ==================== Check CI Image Availability ====================
  check-ci-image:
    name: Check CI Image
    runs-on: ubuntu-latest
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if CI image exists
        id: check
        run: |
          if docker manifest inspect ghcr.io/${{ github.repository }}/ci-base:latest > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "CI image exists, will use container"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "CI image not found, will use fallback"
          fi

  # ==================== Step 1: Discover Apps ====================
  discover-apps:
    name: Discover Apps
    runs-on: ubuntu-latest
    outputs:
      firebase-apps: ${{ steps.discover.outputs.firebase }}
      go-tui-apps: ${{ steps.discover.outputs.go-tui }}
      go-fullstack-apps: ${{ steps.discover.outputs.go-fullstack }}
      go-packages: ${{ steps.discover.outputs.go-package }}
    steps:
      - uses: actions/checkout@v4
      - name: Discover apps
        id: discover
        run: |
          source ./infrastructure/scripts/discover-apps.sh

          # Output as JSON arrays for matrix
          firebase=$(discover_apps . firebase | cut -d: -f1 | jq -R -s -c 'split("\n") | map(select(length > 0))')
          go_tui=$(discover_apps . go-tui | cut -d: -f1 | jq -R -s -c 'split("\n") | map(select(length > 0))')
          go_fullstack=$(discover_apps . go-fullstack | cut -d: -f1 | jq -R -s -c 'split("\n") | map(select(length > 0))')
          go_package=$(discover_apps . go-package | cut -d: -f1 | jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "firebase=$firebase" >> $GITHUB_OUTPUT
          echo "go-tui=$go_tui" >> $GITHUB_OUTPUT
          echo "go-fullstack=$go_fullstack" >> $GITHUB_OUTPUT
          echo "go-package=$go_package" >> $GITHUB_OUTPUT

  # ==================== Firebase App Tests ====================
  test-firebase-fellspiral:
    name: Test Firebase - fellspiral
    runs-on: ubuntu-latest
    needs: discover-apps
    if: contains(fromJson(needs.discover-apps.outputs.firebase-apps), 'fellspiral')
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-pnpm
        with:
          install-playwright: 'true'
      - name: Run tests
        run: ./infrastructure/scripts/test-firebase-app.sh fellspiral

  test-firebase-videobrowser:
    name: Test Firebase - videobrowser
    runs-on: ubuntu-latest
    needs: discover-apps
    if: contains(fromJson(needs.discover-apps.outputs.firebase-apps), 'videobrowser')
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-pnpm
        with:
          install-playwright: 'true'
      - name: Run tests
        run: ./infrastructure/scripts/test-firebase-app.sh videobrowser

  test-firebase-audiobrowser:
    name: Test Firebase - audiobrowser
    runs-on: ubuntu-latest
    needs: discover-apps
    if: contains(fromJson(needs.discover-apps.outputs.firebase-apps), 'audiobrowser')
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-pnpm
        with:
          install-playwright: 'true'
      - name: Run tests
        run: ./infrastructure/scripts/test-firebase-app.sh audiobrowser

  test-firebase-print:
    name: Test Firebase - print
    runs-on: ubuntu-latest
    needs: discover-apps
    if: contains(fromJson(needs.discover-apps.outputs.firebase-apps), 'print')
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-pnpm
        with:
          install-playwright: 'true'
      - name: Run tests
        run: ./infrastructure/scripts/test-firebase-app.sh print

  # ==================== Go TUI App Tests ====================
  test-go-tui-tmux-tui:
    name: Test Go TUI - tmux-tui
    runs-on: ubuntu-latest
    needs: discover-apps
    if: contains(fromJson(needs.discover-apps.outputs.go-tui-apps), 'tmux-tui')
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      - name: Run tests
        run: ./infrastructure/scripts/test-go-tui-app.sh tmux-tui

  # ==================== Go Fullstack App Tests ====================
  test-go-fullstack-printsync:
    name: Test Go Fullstack - printsync
    runs-on: ubuntu-latest
    needs: discover-apps
    if: contains(fromJson(needs.discover-apps.outputs.go-fullstack-apps), 'printsync')
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - uses: ./.github/actions/setup-gcp-auth
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - uses: ./.github/actions/setup-node-pnpm
        with:
          install-playwright: 'true'

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y make

      - name: Install templ
        run: go install github.com/a-h/templ/cmd/templ@latest

      - name: Run tests
        run: ./infrastructure/scripts/test-go-fullstack-app.sh printsync

  # ==================== Go Package Tests ====================
  test-go-packages-filesync:
    name: Test Go Pkg - filesync
    runs-on: ubuntu-latest
    needs: discover-apps
    if: contains(fromJson(needs.discover-apps.outputs.go-packages), 'filesync')
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      - name: Run tests
        run: ./infrastructure/scripts/test-go-package.sh pkg/filesync

  # ==================== Deploy Firestore Rules ====================
  deploy-firestore-rules:
    name: Deploy Firestore Rules
    runs-on: ubuntu-latest
    needs: [test-firebase-fellspiral]
    if: needs.test-firebase-fellspiral.result == 'success'
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install dependencies (jq)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Deploy Firestore rules
        run: |
          set -e
          echo "Deploying Firestore rules..."
          ACCESS_TOKEN=$(gcloud auth print-access-token)
          RULES_CONTENT=$(cat fellspiral/firestore.rules | jq -Rs '.')

          RULESET_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "x-goog-user-project: ${{ env.GCP_PROJECT_ID }}" \
            -H "Content-Type: application/json" \
            -d "{\"source\": {\"files\": [{\"name\": \"firestore.rules\", \"content\": ${RULES_CONTENT}}]}}" \
            "https://firebaserules.googleapis.com/v1/projects/${{ env.GCP_PROJECT_ID }}/rulesets")

          if echo "$RULESET_RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            echo "‚ùå Failed to create ruleset"
            exit 1
          fi

          RULESET_NAME=$(echo "$RULESET_RESPONSE" | jq -r '.name // empty')
          echo "‚úì Created ruleset: $RULESET_NAME"

          RELEASE_RESPONSE=$(curl -s -X PATCH \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "x-goog-user-project: ${{ env.GCP_PROJECT_ID }}" \
            -H "Content-Type: application/json" \
            -d "{\"release\": {\"name\": \"projects/${{ env.GCP_PROJECT_ID }}/releases/cloud.firestore\", \"rulesetName\": \"${RULESET_NAME}\"}}" \
            "https://firebaserules.googleapis.com/v1/projects/${{ env.GCP_PROJECT_ID }}/releases/cloud.firestore")

          if echo "$RELEASE_RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            echo "‚ùå CRITICAL: Failed to release Firestore ruleset"
            echo "Error details:"
            echo "$RELEASE_RESPONSE" | jq '.error'
            exit 1
          fi

          RELEASE_NAME=$(echo "$RELEASE_RESPONSE" | jq -r '.name // empty')
          if [ -z "$RELEASE_NAME" ]; then
            echo "‚ùå CRITICAL: Firestore rules release missing 'name' field"
            exit 1
          fi

          echo "‚úì Firestore rules deployed: $RELEASE_NAME"

  # ==================== Step 2: Deploy Sites (Parallel) ====================
  deploy-fellspiral:
    name: Deploy fellspiral
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test-firebase-fellspiral]
    if: needs.test-firebase-fellspiral.result == 'success'
    outputs:
      url: ${{ steps.site-url.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-node-pnpm
        with:
          install-playwright: 'false'

      - uses: ./.github/actions/setup-gcp-firebase
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Deploy fellspiral to Firebase Hosting
        run: ./infrastructure/scripts/deploy-firebase-hosting.sh fellspiral ${{ github.ref_name }} ${{ github.sha }}

      - name: Get deployment URL
        id: site-url
        run: |
          URL=$(cat /tmp/deployment-url.txt)
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "Fellspiral URL: ${URL}"

  deploy-videobrowser:
    name: Deploy videobrowser
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test-firebase-videobrowser]
    if: needs.test-firebase-videobrowser.result == 'success'
    outputs:
      url: ${{ steps.site-url.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-node-pnpm
        with:
          install-playwright: 'false'

      - uses: ./.github/actions/setup-gcp-firebase
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Deploy videobrowser to Firebase Hosting
        run: ./infrastructure/scripts/deploy-firebase-hosting.sh videobrowser ${{ github.ref_name }} ${{ github.sha }}

      - name: Get deployment URL
        id: site-url
        run: |
          URL=$(cat /tmp/deployment-url.txt)
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "Videobrowser URL: ${URL}"

  deploy-audiobrowser:
    name: Deploy audiobrowser
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test-firebase-audiobrowser]
    if: needs.test-firebase-audiobrowser.result == 'success'
    outputs:
      url: ${{ steps.site-url.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-node-pnpm
        with:
          install-playwright: 'false'

      - uses: ./.github/actions/setup-gcp-firebase
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Deploy audiobrowser to Firebase Hosting
        run: ./infrastructure/scripts/deploy-firebase-hosting.sh audiobrowser ${{ github.ref_name }} ${{ github.sha }}

      - name: Get deployment URL
        id: site-url
        run: |
          URL=$(cat /tmp/deployment-url.txt)
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "Audiobrowser URL: ${URL}"

  deploy-print:
    name: Deploy print
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test-firebase-print]
    if: needs.test-firebase-print.result == 'success'
    outputs:
      url: ${{ steps.site-url.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-node-pnpm
        with:
          install-playwright: 'false'

      - uses: ./.github/actions/setup-gcp-firebase
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Deploy print to Firebase Hosting
        run: ./infrastructure/scripts/deploy-firebase-hosting.sh print ${{ github.ref_name }} ${{ github.sha }}

      - name: Get deployment URL
        id: site-url
        run: |
          URL=$(cat /tmp/deployment-url.txt)
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "Print URL: ${URL}"

  # ==================== Step 3: E2E Tests (parallel per site) ====================
  e2e-fellspiral:
    name: E2E Tests - fellspiral
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [deploy-fellspiral]

    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-node-pnpm
        with:
          install-playwright: 'true'

      - uses: ./.github/actions/setup-gcp-auth
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Test fellspiral
        run: ./infrastructure/scripts/run-playwright-tests.sh fellspiral "${{ needs.deploy-fellspiral.outputs.url }}"
        env:
          DEPLOYED_URL: ${{ needs.deploy-fellspiral.outputs.url }}
          CI: true

  e2e-videobrowser:
    name: E2E Tests - videobrowser
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [deploy-videobrowser]

    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-node-pnpm
        with:
          install-playwright: 'true'

      - uses: ./.github/actions/setup-gcp-auth
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Test videobrowser
        run: ./infrastructure/scripts/run-playwright-tests.sh videobrowser "${{ needs.deploy-videobrowser.outputs.url }}"
        env:
          DEPLOYED_URL: ${{ needs.deploy-videobrowser.outputs.url }}
          CI: true

  e2e-audiobrowser:
    name: E2E Tests - audiobrowser
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [deploy-audiobrowser]

    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-node-pnpm
        with:
          install-playwright: 'true'

      - uses: ./.github/actions/setup-gcp-auth
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Test audiobrowser
        run: ./infrastructure/scripts/run-playwright-tests.sh audiobrowser "${{ needs.deploy-audiobrowser.outputs.url }}"
        env:
          DEPLOYED_URL: ${{ needs.deploy-audiobrowser.outputs.url }}
          CI: true

  e2e-print:
    name: E2E Tests - print
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [deploy-print]

    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-node-pnpm
        with:
          install-playwright: 'true'

      - uses: ./.github/actions/setup-gcp-auth
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Test print
        run: ./infrastructure/scripts/run-playwright-tests.sh print "${{ needs.deploy-print.outputs.url }}"
        env:
          DEPLOYED_URL: ${{ needs.deploy-print.outputs.url }}
          CI: true

  # ==================== Rollback on failure (main branch only) ====================
  rollback-on-failure:
    name: Rollback on Test Failure
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [
      deploy-fellspiral, deploy-videobrowser, deploy-audiobrowser, deploy-print,
      e2e-fellspiral, e2e-videobrowser, e2e-audiobrowser, e2e-print
    ]
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      (needs.e2e-fellspiral.result == 'failure' ||
       needs.e2e-videobrowser.result == 'failure' ||
       needs.e2e-audiobrowser.result == 'failure' ||
       needs.e2e-print.result == 'failure')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Note about Firebase Hosting rollback
        run: |
          echo "‚ö†Ô∏è  Firebase Hosting deployments don't support automatic rollback"
          echo "üìù To manually rollback, use: firebase hosting:rollback <site-id>"
          echo "üîç Sites: fellspiral, videobrowser-7696a, audiobrowser, print-dfb47"
          echo ""
          echo "Previous deployments are still available in Firebase Hosting history"

      - name: Create rollback issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Automatic Rollback: All Sites',
              body: `E2E tests failed after deployment to main branch.\n\nCommit: ${context.sha}\n\nWorkflow: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['bug', 'deployment', 'rollback']
            })

  # ==================== Merge Check (Required Status Check) ====================
  merge-check:
    name: Merge Check - All Tests Passed
    runs-on: ubuntu-latest
    needs: [
      test-firebase-fellspiral, test-firebase-videobrowser,
      test-firebase-audiobrowser, test-firebase-print,
      test-go-fullstack-printsync,
      test-go-tui-tmux-tui,
      test-go-packages-filesync,
      deploy-firestore-rules,
      deploy-fellspiral, deploy-videobrowser, deploy-audiobrowser, deploy-print,
      e2e-fellspiral, e2e-videobrowser, e2e-audiobrowser, e2e-print
    ]
    if: always()

    steps:
      - name: Check all jobs succeeded
        uses: actions/github-script@v7
        with:
          script: |
            const testJobs = [
              'test-firebase-fellspiral', 'test-firebase-videobrowser',
              'test-firebase-audiobrowser', 'test-firebase-print',
              'test-go-fullstack-printsync', 'test-go-tui-tmux-tui',
              'test-go-packages-filesync'
            ];
            const deployJobs = [
              'deploy-fellspiral', 'deploy-videobrowser',
              'deploy-audiobrowser', 'deploy-print',
              'deploy-firestore-rules'
            ];
            const e2eJobs = [
              'e2e-fellspiral', 'e2e-videobrowser',
              'e2e-audiobrowser', 'e2e-print'
            ];

            const needs = ${{ toJson(needs) }};
            let failed = false;

            // Test jobs can be skipped (if app doesn't exist)
            for (const job of testJobs) {
              const result = needs[job]?.result;
              if (result !== 'success' && result !== 'skipped') {
                console.log(`‚ùå ${job} failed with result: ${result}`);
                failed = true;
              }
            }

            // Deploy/E2E jobs should NEVER skip
            for (const job of [...deployJobs, ...e2eJobs]) {
              const result = needs[job]?.result;
              if (result === 'skipped') {
                console.log(`‚ùå CRITICAL: ${job} was skipped (workflow bug)`);
                failed = true;
              } else if (result !== 'success') {
                console.log(`‚ùå ${job} failed with result: ${result}`);
                failed = true;
              }
            }

            if (failed) {
              core.setFailed('Required jobs did not pass');
            } else {
              console.log('‚úÖ All required jobs succeeded');
            }
