name: Main/PR Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches: ['**']
  merge_group:
  workflow_dispatch:

concurrency:
  group: push-main-${{ github.ref }}
  cancel-in-progress: true

env:
  GCP_PROJECT_ID: chalanding
  GCP_REGION: us-central1

permissions:
  contents: write
  id-token: write
  pull-requests: write
  issues: write
  actions: write
  packages: read
  deployments: write

jobs:
  # ==================== MINIMAL TEST: One Firebase test using ./test CLI ====================
  test-firebase-fellspiral:
    name: Test Firebase - fellspiral
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-pnpm
        with:
          install-playwright: 'true'
          install-firebase: 'true'
      - name: Run tests
        run: ./test --module=fellspiral --type=e2e --ci

  # ==================== Merge Check ====================
  merge-check:
    name: Merge Check - All Tests Passed
    runs-on: ubuntu-latest
    needs: [test-firebase-fellspiral]
    if: always()
    steps:
      - name: Check all jobs succeeded
        run: |
          if [ "${{ needs.test-firebase-fellspiral.result }}" != "success" ]; then
            echo "test-firebase-fellspiral failed"
            exit 1
          fi
          echo "All tests passed"
