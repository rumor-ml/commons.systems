name: Main/PR Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches: ['**']

# Only allow one pipeline per ref at a time
concurrency:
  group: push-main-${{ github.ref }}
  cancel-in-progress: true

env:
  GCP_PROJECT_ID: chalanding
  GCP_REGION: us-central1

permissions:
  contents: write
  id-token: write
  pull-requests: write
  issues: write
  actions: read
  packages: read

jobs:
  # ==================== Check CI Image Availability ====================
  check-ci-image:
    name: Check CI Image
    runs-on: ubuntu-latest
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if CI image exists
        id: check
        run: |
          if docker manifest inspect ghcr.io/${{ github.repository }}/ci-base:latest > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "CI image exists, will use container"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "CI image not found, will use fallback"
          fi

  # ==================== Step 1: Discover Apps ====================
  discover-apps:
    name: Discover Apps
    runs-on: ubuntu-latest
    outputs:
      firebase-apps: ${{ steps.discover.outputs.firebase }}
      go-tui-apps: ${{ steps.discover.outputs.go-tui }}
      go-fullstack-apps: ${{ steps.discover.outputs.go-fullstack }}
      go-packages: ${{ steps.discover.outputs.go-package }}
    steps:
      - uses: actions/checkout@v4
      - name: Discover apps
        id: discover
        run: |
          source ./infrastructure/scripts/discover-apps.sh

          # Output as JSON arrays for matrix
          firebase=$(discover_apps . firebase | cut -d: -f1 | jq -R -s -c 'split("\n") | map(select(length > 0))')
          go_tui=$(discover_apps . go-tui | cut -d: -f1 | jq -R -s -c 'split("\n") | map(select(length > 0))')
          go_fullstack=$(discover_apps . go-fullstack | cut -d: -f1 | jq -R -s -c 'split("\n") | map(select(length > 0))')
          go_package=$(discover_apps . go-package | cut -d: -f1 | jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "firebase=$firebase" >> $GITHUB_OUTPUT
          echo "go-tui=$go_tui" >> $GITHUB_OUTPUT
          echo "go-fullstack=$go_fullstack" >> $GITHUB_OUTPUT
          echo "go-package=$go_package" >> $GITHUB_OUTPUT

  # ==================== Firebase App Tests ====================
  test-firebase:
    name: Test Firebase - ${{ matrix.app }}
    runs-on: ubuntu-latest
    needs: discover-apps
    if: needs.discover-apps.outputs.firebase-apps != '[]'
    timeout-minutes: 15
    strategy:
      matrix:
        app: ${{ fromJson(needs.discover-apps.outputs.firebase-apps) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile
          npx playwright install chromium --with-deps
      - name: Run tests
        run: ./infrastructure/scripts/test-firebase-app.sh ${{ matrix.app }}

  # ==================== Go TUI App Tests ====================
  test-go-tui:
    name: Test Go TUI - ${{ matrix.app }}
    runs-on: ubuntu-latest
    needs: discover-apps
    if: needs.discover-apps.outputs.go-tui-apps != '[]'
    timeout-minutes: 10
    strategy:
      matrix:
        app: ${{ fromJson(needs.discover-apps.outputs.go-tui-apps) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      - name: Run tests
        run: ./infrastructure/scripts/test-go-tui-app.sh ${{ matrix.app }}

  # ==================== Go Fullstack App Tests ====================
  test-go-fullstack:
    name: Test Go Fullstack - ${{ matrix.app }}
    runs-on: ubuntu-latest
    needs: discover-apps
    if: needs.discover-apps.outputs.go-fullstack-apps != '[]'
    timeout-minutes: 15
    strategy:
      matrix:
        app: ${{ fromJson(needs.discover-apps.outputs.go-fullstack-apps) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y make
          go install github.com/a-h/templ/cmd/templ@latest
          pnpm install --frozen-lockfile
          npx playwright install chromium --with-deps
      - name: Run tests
        run: ./infrastructure/scripts/test-go-fullstack-app.sh ${{ matrix.app }}

  # ==================== Go Package Tests ====================
  test-go-packages:
    name: Test Go Pkg - ${{ matrix.pkg }}
    runs-on: ubuntu-latest
    needs: discover-apps
    if: needs.discover-apps.outputs.go-packages != '[]'
    timeout-minutes: 10
    strategy:
      matrix:
        pkg: ${{ fromJson(needs.discover-apps.outputs.go-packages) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      - name: Run tests
        run: ./infrastructure/scripts/test-go-package.sh pkg/${{ matrix.pkg }}

  # ==================== Step 2: Deploy Sites (Parallel) ====================
  deploy-fellspiral:
    name: Deploy fellspiral
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test-firebase, test-go-tui, test-go-fullstack, test-go-packages]
    if: |
      always() &&
      (needs.test-firebase.result == 'success' || needs.test-firebase.result == 'skipped') &&
      (needs.test-go-tui.result == 'success' || needs.test-go-tui.result == 'skipped') &&
      (needs.test-go-fullstack.result == 'success' || needs.test-go-fullstack.result == 'skipped') &&
      (needs.test-go-packages.result == 'success' || needs.test-go-packages.result == 'skipped')
    outputs:
      url: ${{ steps.site-url.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install dependencies (jq)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Cache Firebase CLI
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: firebase-cli-${{ runner.os }}-v1
          restore-keys: |
            firebase-cli-${{ runner.os }}-

      - name: Install Firebase CLI
        run: pnpm add -g firebase-tools

      # Note: Firebase configuration is injected by deploy-firebase-hosting.sh script

      # ========== Deploy Firestore Rules (Fellspiral only) ==========
      - name: Deploy Firestore rules
        run: |
          set -e
          echo "Deploying Firestore rules..."
          ACCESS_TOKEN=$(gcloud auth print-access-token)
          RULES_CONTENT=$(cat fellspiral/firestore.rules | jq -Rs '.')

          RULESET_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "x-goog-user-project: ${{ env.GCP_PROJECT_ID }}" \
            -H "Content-Type: application/json" \
            -d "{\"source\": {\"files\": [{\"name\": \"firestore.rules\", \"content\": ${RULES_CONTENT}}]}}" \
            "https://firebaserules.googleapis.com/v1/projects/${{ env.GCP_PROJECT_ID }}/rulesets")

          if echo "$RULESET_RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            echo "‚ùå Failed to create ruleset"
            exit 1
          fi

          RULESET_NAME=$(echo "$RULESET_RESPONSE" | jq -r '.name // empty')
          echo "‚úì Created ruleset: $RULESET_NAME"

          RELEASE_RESPONSE=$(curl -s -X PATCH \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "x-goog-user-project: ${{ env.GCP_PROJECT_ID }}" \
            -H "Content-Type: application/json" \
            -d "{\"release\": {\"name\": \"projects/${{ env.GCP_PROJECT_ID }}/releases/cloud.firestore\", \"rulesetName\": \"${RULESET_NAME}\"}}" \
            "https://firebaserules.googleapis.com/v1/projects/${{ env.GCP_PROJECT_ID }}/releases/cloud.firestore")

          if echo "$RELEASE_RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Failed to release ruleset"
          else
            echo "‚úì Firestore rules deployed"
          fi

      # ========== Deploy Site ==========
      - name: Deploy fellspiral to Firebase Hosting
        run: ./infrastructure/scripts/deploy-firebase-hosting.sh fellspiral ${{ github.ref_name }} ${{ github.sha }}

      - name: Get deployment URL
        id: site-url
        run: |
          URL=$(cat /tmp/deployment-url.txt)
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "Fellspiral URL: ${URL}"

  deploy-videobrowser:
    name: Deploy videobrowser
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test-firebase, test-go-tui, test-go-fullstack, test-go-packages]
    if: |
      always() &&
      (needs.test-firebase.result == 'success' || needs.test-firebase.result == 'skipped') &&
      (needs.test-go-tui.result == 'success' || needs.test-go-tui.result == 'skipped') &&
      (needs.test-go-fullstack.result == 'success' || needs.test-go-fullstack.result == 'skipped') &&
      (needs.test-go-packages.result == 'success' || needs.test-go-packages.result == 'skipped')
    outputs:
      url: ${{ steps.site-url.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install dependencies (jq)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Cache Firebase CLI
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: firebase-cli-${{ runner.os }}-v1
          restore-keys: |
            firebase-cli-${{ runner.os }}-

      - name: Install Firebase CLI
        run: pnpm add -g firebase-tools

      # ========== Deploy Site ==========
      - name: Deploy videobrowser to Firebase Hosting
        run: ./infrastructure/scripts/deploy-firebase-hosting.sh videobrowser ${{ github.ref_name }} ${{ github.sha }}

      - name: Get deployment URL
        id: site-url
        run: |
          URL=$(cat /tmp/deployment-url.txt)
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "Videobrowser URL: ${URL}"

  deploy-audiobrowser:
    name: Deploy audiobrowser
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test-firebase, test-go-tui, test-go-fullstack, test-go-packages]
    if: |
      always() &&
      (needs.test-firebase.result == 'success' || needs.test-firebase.result == 'skipped') &&
      (needs.test-go-tui.result == 'success' || needs.test-go-tui.result == 'skipped') &&
      (needs.test-go-fullstack.result == 'success' || needs.test-go-fullstack.result == 'skipped') &&
      (needs.test-go-packages.result == 'success' || needs.test-go-packages.result == 'skipped')
    outputs:
      url: ${{ steps.site-url.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install dependencies (jq)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Cache Firebase CLI
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: firebase-cli-${{ runner.os }}-v1
          restore-keys: |
            firebase-cli-${{ runner.os }}-

      - name: Install Firebase CLI
        run: pnpm add -g firebase-tools

      # ========== Deploy Site ==========
      - name: Deploy audiobrowser to Firebase Hosting
        run: ./infrastructure/scripts/deploy-firebase-hosting.sh audiobrowser ${{ github.ref_name }} ${{ github.sha }}

      - name: Get deployment URL
        id: site-url
        run: |
          URL=$(cat /tmp/deployment-url.txt)
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "Audiobrowser URL: ${URL}"

  deploy-print:
    name: Deploy print
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test-firebase, test-go-tui, test-go-fullstack, test-go-packages]
    if: |
      always() &&
      (needs.test-firebase.result == 'success' || needs.test-firebase.result == 'skipped') &&
      (needs.test-go-tui.result == 'success' || needs.test-go-tui.result == 'skipped') &&
      (needs.test-go-fullstack.result == 'success' || needs.test-go-fullstack.result == 'skipped') &&
      (needs.test-go-packages.result == 'success' || needs.test-go-packages.result == 'skipped')
    outputs:
      url: ${{ steps.site-url.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install dependencies (jq)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Cache Firebase CLI
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: firebase-cli-${{ runner.os }}-v1
          restore-keys: |
            firebase-cli-${{ runner.os }}-

      - name: Install Firebase CLI
        run: pnpm add -g firebase-tools

      # ========== Deploy Site ==========
      - name: Deploy print to Firebase Hosting
        run: ./infrastructure/scripts/deploy-firebase-hosting.sh print ${{ github.ref_name }} ${{ github.sha }}

      - name: Get deployment URL
        id: site-url
        run: |
          URL=$(cat /tmp/deployment-url.txt)
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "Print URL: ${URL}"

  # ==================== Step 3: E2E Tests (parallel per site) ====================
  e2e-fellspiral:
    name: E2E Tests - fellspiral
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [deploy-fellspiral]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Test fellspiral
        run: ./infrastructure/scripts/run-playwright-tests.sh fellspiral "${{ needs.deploy-fellspiral.outputs.url }}"
        env:
          DEPLOYED_URL: ${{ needs.deploy-fellspiral.outputs.url }}
          CI: true

  e2e-videobrowser:
    name: E2E Tests - videobrowser
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [deploy-videobrowser]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Test videobrowser
        run: ./infrastructure/scripts/run-playwright-tests.sh videobrowser "${{ needs.deploy-videobrowser.outputs.url }}"
        env:
          DEPLOYED_URL: ${{ needs.deploy-videobrowser.outputs.url }}
          CI: true

  e2e-audiobrowser:
    name: E2E Tests - audiobrowser
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [deploy-audiobrowser]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Test audiobrowser
        run: ./infrastructure/scripts/run-playwright-tests.sh audiobrowser "${{ needs.deploy-audiobrowser.outputs.url }}"
        env:
          DEPLOYED_URL: ${{ needs.deploy-audiobrowser.outputs.url }}
          CI: true

  e2e-print:
    name: E2E Tests - print
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [deploy-print]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Test print
        run: ./infrastructure/scripts/run-playwright-tests.sh print "${{ needs.deploy-print.outputs.url }}"
        env:
          DEPLOYED_URL: ${{ needs.deploy-print.outputs.url }}
          CI: true

  # ==================== Rollback on failure (main branch only) ====================
  rollback-on-failure:
    name: Rollback on Test Failure
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [deploy-fellspiral, deploy-videobrowser, deploy-audiobrowser, deploy-print, e2e-fellspiral, e2e-videobrowser, e2e-audiobrowser, e2e-print]
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      (needs.e2e-fellspiral.result == 'failure' ||
       needs.e2e-videobrowser.result == 'failure' ||
       needs.e2e-audiobrowser.result == 'failure' ||
       needs.e2e-print.result == 'failure')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Note about Firebase Hosting rollback
        run: |
          echo "‚ö†Ô∏è  Firebase Hosting deployments don't support automatic rollback"
          echo "üìù To manually rollback, use: firebase hosting:rollback <site-id>"
          echo "üîç Sites: fellspiral, videobrowser-7696a, audiobrowser, print-dfb47"
          echo ""
          echo "Previous deployments are still available in Firebase Hosting history"

      - name: Create rollback issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Automatic Rollback: All Sites',
              body: `E2E tests failed after deployment to main branch.\n\nCommit: ${context.sha}\n\nWorkflow: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['bug', 'deployment', 'rollback']
            })

  # ==================== Merge Check (Required Status Check) ====================
  merge-check:
    name: Merge Check - All Tests Passed
    runs-on: ubuntu-latest
    needs: [test-firebase, test-go-tui, test-go-fullstack, test-go-packages, deploy-fellspiral, deploy-videobrowser, deploy-audiobrowser, deploy-print, e2e-fellspiral, e2e-videobrowser, e2e-audiobrowser, e2e-print]
    if: always()

    steps:
      - name: Check all jobs succeeded
        run: |
          echo "Checking job results..."
          echo "Firebase Tests: ${{ needs.test-firebase.result }}"
          echo "Go TUI Tests: ${{ needs.test-go-tui.result }}"
          echo "Go Fullstack Tests: ${{ needs.test-go-fullstack.result }}"
          echo "Go Package Tests: ${{ needs.test-go-packages.result }}"
          echo "Deploy Fellspiral: ${{ needs.deploy-fellspiral.result }}"
          echo "Deploy Videobrowser: ${{ needs.deploy-videobrowser.result }}"
          echo "Deploy Audiobrowser: ${{ needs.deploy-audiobrowser.result }}"
          echo "Deploy Print: ${{ needs.deploy-print.result }}"
          echo "E2E Fellspiral: ${{ needs.e2e-fellspiral.result }}"
          echo "E2E Videobrowser: ${{ needs.e2e-videobrowser.result }}"
          echo "E2E Audiobrowser: ${{ needs.e2e-audiobrowser.result }}"
          echo "E2E Print: ${{ needs.e2e-print.result }}"

          # All jobs must succeed or be skipped for merge check to pass
          # Skipped jobs (when no apps of that type exist) are okay
          if [[ "${{ needs.test-firebase.result }}" != "success" && "${{ needs.test-firebase.result }}" != "skipped" ]]; then
            echo "‚ùå Firebase tests failed"
            exit 1
          fi

          if [[ "${{ needs.test-go-tui.result }}" != "success" && "${{ needs.test-go-tui.result }}" != "skipped" ]]; then
            echo "‚ùå Go TUI tests failed"
            exit 1
          fi

          if [[ "${{ needs.test-go-fullstack.result }}" != "success" && "${{ needs.test-go-fullstack.result }}" != "skipped" ]]; then
            echo "‚ùå Go fullstack tests failed"
            exit 1
          fi

          if [[ "${{ needs.test-go-packages.result }}" != "success" && "${{ needs.test-go-packages.result }}" != "skipped" ]]; then
            echo "‚ùå Go package tests failed"
            exit 1
          fi

          if [ "${{ needs.deploy-fellspiral.result }}" != "success" ]; then
            echo "‚ùå Fellspiral deployment failed or was skipped"
            exit 1
          fi

          if [ "${{ needs.deploy-videobrowser.result }}" != "success" ]; then
            echo "‚ùå Videobrowser deployment failed or was skipped"
            exit 1
          fi

          if [ "${{ needs.deploy-audiobrowser.result }}" != "success" ]; then
            echo "‚ùå Audiobrowser deployment failed or was skipped"
            exit 1
          fi

          if [ "${{ needs.deploy-print.result }}" != "success" ]; then
            echo "‚ùå Print deployment failed or was skipped"
            exit 1
          fi

          if [ "${{ needs.e2e-fellspiral.result }}" != "success" ]; then
            echo "‚ùå Fellspiral E2E tests failed or were skipped"
            exit 1
          fi

          if [ "${{ needs.e2e-videobrowser.result }}" != "success" ]; then
            echo "‚ùå Videobrowser E2E tests failed or were skipped"
            exit 1
          fi

          if [ "${{ needs.e2e-audiobrowser.result }}" != "success" ]; then
            echo "‚ùå Audiobrowser E2E tests failed or were skipped"
            exit 1
          fi

          if [ "${{ needs.e2e-print.result }}" != "success" ]; then
            echo "‚ùå Print E2E tests failed or were skipped"
            exit 1
          fi

          echo "‚úÖ All required jobs succeeded - merge check passed!"
