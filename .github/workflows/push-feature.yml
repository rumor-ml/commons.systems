name: Feature Branch Pipeline (Firebase Hosting)

on:
  push:
    branches:
      - '**'
      - '!main'

# Only allow one pipeline per branch at a time
concurrency:
  group: push-feature-${{ github.ref }}
  cancel-in-progress: true

env:
  GCP_PROJECT_ID: chalanding
  GCP_REGION: us-central1

permissions:
  contents: write
  id-token: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  # Prevent feature workflow from running when PR exists for this branch,
  # since PR workflow (push-main.yml) handles CI/CD for branches with open PRs.
  # This avoids duplicate deployments and wasted CI resources.
  check-pr-exists:
    name: Check PR Status
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      should-continue: ${{ steps.check.outputs.should-continue }}
    steps:
      - name: Check for PR and skip if exists
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e          # Exit immediately if a command fails
          set -o pipefail # Catch failures in pipes
          set -u          # Treat unset variables as errors

          echo "=== Checking for existing PR ==="

          # Validate GITHUB_REF is set and has expected format
          if [ -z "${GITHUB_REF:-}" ]; then
            echo "::error::GITHUB_REF environment variable is empty or unset"
            exit 1
          fi

          # Extract and validate branch name
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          if [ -z "$BRANCH_NAME" ] || [ "$BRANCH_NAME" = "$GITHUB_REF" ]; then
            echo "::error::Failed to extract branch name from GITHUB_REF='$GITHUB_REF'"
            echo "::error::Expected format: refs/heads/<branch-name>"
            exit 1
          fi

          echo "Branch: $BRANCH_NAME"
          echo "Repository: $GITHUB_REPOSITORY"

          # Query GitHub API for open PRs with timeout
          # Check if there are any open PRs FROM this branch (--head)
          echo "Querying GitHub API for open PRs..."
          if ! PR_LIST_OUTPUT=$(timeout 30s gh pr list \
            --repo "$GITHUB_REPOSITORY" \
            --head "$BRANCH_NAME" \
            --state open \
            --json number 2>&1); then
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 124 ]; then
              echo "::error::GitHub API query timed out after 30 seconds"
              echo "::error::This may indicate GitHub API slowness or network issues"
            else
              echo "::error::Failed to query GitHub API for PR status"
              echo "::error::Repository: $GITHUB_REPOSITORY"
              echo "::error::Branch: $BRANCH_NAME"
              echo "::error::Output: $PR_LIST_OUTPUT"
            fi
            echo "::error::Cannot determine PR status - failing workflow to prevent duplicate operations"
            exit 1
          fi

          # Parse PR count from JSON with validation
          if ! PR_COUNT=$(echo "$PR_LIST_OUTPUT" | jq -e 'length' 2>&1); then
            echo "::error::Failed to parse GitHub API response as JSON"
            echo "::error::jq error: $PR_COUNT"
            echo "::error::Raw output: $PR_LIST_OUTPUT"
            exit 1
          fi

          # Validate PR_COUNT is a non-negative integer
          if ! [[ "$PR_COUNT" =~ ^[0-9]+$ ]]; then
            echo "::error::PR count is not a valid non-negative integer: '$PR_COUNT'"
            echo "::error::This indicates unexpected GitHub API response format"
            exit 1
          fi

          echo "Found $PR_COUNT open PR(s) for branch '$BRANCH_NAME'"

          # Set output to control downstream jobs
          if [ "$PR_COUNT" -gt 0 ]; then
            echo "::notice::Open PR exists for branch '$BRANCH_NAME'"
            echo "::notice::Feature workflow will skip - PR workflow handles this branch"
            echo "should-continue=false" >> $GITHUB_OUTPUT
          else
            echo "::notice::No open PR found for branch '$BRANCH_NAME'"
            echo "::notice::Continuing with feature workflow"
            echo "should-continue=true" >> $GITHUB_OUTPUT
          fi

  # ==================== Step 0: Change Detection ====================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: check-pr-exists
    if: needs.check-pr-exists.outputs.should-continue == 'true'
    outputs:
      fellspiral-changed: ${{ steps.check-changes.outputs.fellspiral-changed }}
      videobrowser-changed: ${{ steps.check-changes.outputs.videobrowser-changed }}
      audiobrowser-changed: ${{ steps.check-changes.outputs.audiobrowser-changed }}
      print-changed: ${{ steps.check-changes.outputs.print-changed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for changes
        id: check-changes
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)

          # Check fellspiral changes
          if echo "$CHANGED_FILES" | grep -qE "^(fellspiral/|shared/auth/)"; then
            echo "fellspiral-changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Fellspiral changed"
          else
            echo "fellspiral-changed=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸  Fellspiral unchanged"
          fi

          # Check videobrowser changes
          if echo "$CHANGED_FILES" | grep -qE "^(videobrowser/|shared/auth/)"; then
            echo "videobrowser-changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Videobrowser changed"
          else
            echo "videobrowser-changed=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸  Videobrowser unchanged"
          fi

          # Check audiobrowser changes
          if echo "$CHANGED_FILES" | grep -qE "^(audiobrowser/|shared/auth/)"; then
            echo "audiobrowser-changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Audiobrowser changed"
          else
            echo "audiobrowser-changed=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸  Audiobrowser unchanged"
          fi

          # Check print changes
          if git diff --name-only HEAD^ HEAD | grep -q "^print/"; then
            echo "print-changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Print changed"
          else
            echo "print-changed=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸  Print unchanged"
          fi

  # ==================== Step 1: Local Tests (parallel per site) ====================
  local-tests:
    name: Local Tests - ${{ matrix.site }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: detect-changes
    strategy:
      matrix:
        site: [fellspiral, videobrowser, audiobrowser]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Test ${{ matrix.site }}
        run: ./infrastructure/scripts/run-local-tests.sh ${{ matrix.site }}

      - name: Test Print
        if: steps.check-changes.outputs.print-changed == 'true'
        run: ./infrastructure/scripts/run-local-tests.sh print

  # ==================== Step 2: Deploy Sites to Firebase Hosting ====================
  deploy-fellspiral:
    name: Deploy Fellspiral (Preview)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [detect-changes, local-tests]
    if: |
      always() &&
      needs.detect-changes.outputs.fellspiral-changed == 'true' &&
      (needs.local-tests.result == 'success' || needs.local-tests.result == 'skipped')
    outputs:
      service-url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install Firebase CLI
        run: pnpm add -g firebase-tools

      - name: Deploy to Firebase Hosting Preview
        id: deploy
        run: |
          ./infrastructure/scripts/deploy-firebase-hosting.sh fellspiral ${{ github.ref_name }} ${{ github.sha }}
          URL=$(cat /tmp/deployment-url.txt)
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "Deployed to: ${URL}"

  deploy-videobrowser:
    name: Deploy Videobrowser (Preview)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [detect-changes, local-tests]
    if: |
      always() &&
      needs.detect-changes.outputs.videobrowser-changed == 'true' &&
      (needs.local-tests.result == 'success' || needs.local-tests.result == 'skipped')
    outputs:
      service-url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install Firebase CLI
        run: pnpm add -g firebase-tools

      - name: Deploy to Firebase Hosting Preview
        id: deploy
        run: |
          ./infrastructure/scripts/deploy-firebase-hosting.sh videobrowser ${{ github.ref_name }} ${{ github.sha }}
          URL=$(cat /tmp/deployment-url.txt)
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "Deployed to: ${URL}"

  deploy-audiobrowser:
    name: Deploy Audiobrowser (Preview)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [detect-changes, local-tests]
    if: |
      always() &&
      needs.detect-changes.outputs.audiobrowser-changed == 'true' &&
      (needs.local-tests.result == 'success' || needs.local-tests.result == 'skipped')
    outputs:
      service-url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install Firebase CLI
        run: pnpm add -g firebase-tools

      - name: Deploy to Firebase Hosting Preview
        id: deploy
        run: |
          ./infrastructure/scripts/deploy-firebase-hosting.sh audiobrowser ${{ github.ref_name }} ${{ github.sha }}
          URL=$(cat /tmp/deployment-url.txt)
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "Deployed to: ${URL}"

  deploy-print:
    name: Deploy Print (Preview)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: local-tests
    if: needs.local-tests.outputs.print-changed == 'true'
    outputs:
      service-url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install Firebase CLI
        run: pnpm add -g firebase-tools

      - name: Deploy to Firebase Hosting Preview
        id: deploy
        run: |
          ./infrastructure/scripts/deploy-firebase-hosting.sh print ${{ github.ref_name }} ${{ github.sha }}
          URL=$(cat /tmp/deployment-url.txt)
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "Deployed to: ${URL}"

  # ==================== Step 3: Collect All Deployment URLs ====================
  collect-deployment-urls:
    name: Collect Deployment URLs
    runs-on: ubuntu-latest
    needs: [deploy-fellspiral, deploy-videobrowser, deploy-audiobrowser, deploy-print]
    if: |
      always() &&
      (needs.deploy-fellspiral.result == 'success' ||
       needs.deploy-videobrowser.result == 'success' ||
       needs.deploy-audiobrowser.result == 'success' ||
       needs.deploy-print.result == 'success')
    outputs:
      fellspiral-url: ${{ needs.deploy-fellspiral.outputs.service-url }}
      videobrowser-url: ${{ needs.deploy-videobrowser.outputs.service-url }}
      audiobrowser-url: ${{ needs.deploy-audiobrowser.outputs.service-url }}
      print-url: ${{ needs.deploy-print.outputs.service-url }}

    steps:
      - name: Echo deployment URLs
        run: |
          echo "Fellspiral: ${{ needs.deploy-fellspiral.outputs.service-url }}"
          echo "Videobrowser: ${{ needs.deploy-videobrowser.outputs.service-url }}"
          echo "Audiobrowser: ${{ needs.deploy-audiobrowser.outputs.service-url }}"
          echo "Print: ${{ needs.deploy-print.outputs.service-url }}"

  # ==================== Step 4: E2E Tests (Matrix Strategy) ====================
  playwright-tests:
    name: E2E Tests - ${{ matrix.site }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: collect-deployment-urls
    strategy:
      matrix:
        site: [fellspiral, videobrowser, audiobrowser, print]
      fail-fast: false
    if: |
      always() &&
      needs.collect-deployment-urls.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get site URL
        id: site-url
        run: |
          case "${{ matrix.site }}" in
            fellspiral)
              URL="${{ needs.collect-deployment-urls.outputs.fellspiral-url }}"
              ;;
            videobrowser)
              URL="${{ needs.collect-deployment-urls.outputs.videobrowser-url }}"
              ;;
            audiobrowser)
              URL="${{ needs.collect-deployment-urls.outputs.audiobrowser-url }}"
              ;;
            print)
              URL="${{ needs.collect-deployment-urls.outputs.print-url }}"
              ;;
          esac

          if [ -z "$URL" ]; then
            echo "No deployment URL for ${{ matrix.site }}, skipping tests"
            exit 0
          fi

          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "${{ matrix.site }} URL: ${URL}"

      - name: Run Playwright tests
        if: steps.site-url.outputs.url != ''
        run: ./infrastructure/scripts/run-playwright-tests.sh ${{ matrix.site }} "${{ steps.site-url.outputs.url }}"
        env:
          DEPLOYED_URL: ${{ steps.site-url.outputs.url }}
          CI: true

  # ==================== Summary ====================
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [local-tests, deploy-fellspiral, deploy-videobrowser, deploy-audiobrowser, deploy-print, playwright-tests]
    if: always()

    steps:
      - name: Create summary
        run: |
          echo "# ðŸš€ Feature Branch Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployments (Firebase Hosting Previews)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy-fellspiral.result }}" = "success" ]; then
            echo "- âœ… **Fellspiral**: ${{ needs.deploy-fellspiral.outputs.service-url }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.deploy-videobrowser.result }}" = "success" ]; then
            echo "- âœ… **Videobrowser**: ${{ needs.deploy-videobrowser.outputs.service-url }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.deploy-audiobrowser.result }}" = "success" ]; then
            echo "- âœ… **Audiobrowser**: ${{ needs.deploy-audiobrowser.outputs.service-url }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.deploy-print.result }}" = "success" ]; then
            echo "- âœ… **Print**: ${{ needs.deploy-print.outputs.service-url }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Local Tests: ${{ needs.local-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- E2E Tests: ${{ needs.playwright-tests.result }}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”¥ **Firebase Hosting**: All deployments use Firebase Hosting with automatic auth authorization" >> $GITHUB_STEP_SUMMARY
          echo "â° **Preview expiration**: 7 days from deployment" >> $GITHUB_STEP_SUMMARY
