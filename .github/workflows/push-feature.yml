name: Feature Branch Pipeline (Firebase Hosting)

on:
  push:
    branches:
      - '**'
      - '!main'

# Only allow one pipeline per branch at a time
concurrency:
  group: push-feature-${{ github.ref }}
  cancel-in-progress: true

env:
  GCP_PROJECT_ID: chalanding
  GCP_REGION: us-central1

permissions:
  contents: write
  id-token: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  # ==================== Step 0: Change Detection ====================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      fellspiral-changed: ${{ steps.check-changes.outputs.fellspiral-changed }}
      videobrowser-changed: ${{ steps.check-changes.outputs.videobrowser-changed }}
      audiobrowser-changed: ${{ steps.check-changes.outputs.audiobrowser-changed }}
      print-changed: ${{ steps.check-changes.outputs.print-changed }}
      playwright-server-changed: ${{ steps.check-changes.outputs.playwright-server-changed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for changes
        id: check-changes
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)

          # Check fellspiral changes
          if echo "$CHANGED_FILES" | grep -qE "^(fellspiral/|shared/auth/)"; then
            echo "fellspiral-changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Fellspiral changed"
          else
            echo "fellspiral-changed=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸  Fellspiral unchanged"
          fi

          # Check videobrowser changes
          if echo "$CHANGED_FILES" | grep -qE "^(videobrowser/|shared/auth/)"; then
            echo "videobrowser-changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Videobrowser changed"
          else
            echo "videobrowser-changed=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸  Videobrowser unchanged"
          fi

          # Check audiobrowser changes
          if echo "$CHANGED_FILES" | grep -qE "^(audiobrowser/|shared/auth/)"; then
            echo "audiobrowser-changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Audiobrowser changed"
          else
            echo "audiobrowser-changed=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸  Audiobrowser unchanged"
          fi

          # Check print changes
          if git diff --name-only HEAD^ HEAD | grep -q "^print/"; then
            echo "print-changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Print changed"
          else
            echo "print-changed=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸  Print unchanged"
          fi

          # Check playwright-server changes
          if echo "$CHANGED_FILES" | grep -q "^infrastructure/playwright-server/"; then
            echo "playwright-server-changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Playwright server changed"
          else
            echo "playwright-server-changed=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸  Playwright server unchanged"
          fi

  # ==================== Step 1: Local Tests (parallel per site) ====================
  local-tests:
    name: Local Tests - ${{ matrix.site }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: detect-changes
    strategy:
      matrix:
        site: [fellspiral, videobrowser, audiobrowser]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            */*/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm install

      - name: Test ${{ matrix.site }}
        run: ./infrastructure/scripts/run-local-tests.sh ${{ matrix.site }}

      - name: Test Print
        if: steps.check-changes.outputs.print-changed == 'true'
        run: ./infrastructure/scripts/run-local-tests.sh print

  # ==================== Step 2: Deploy Playwright Server (if changed) ====================
  deploy-playwright-server:
    name: Deploy Playwright Server
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: detect-changes
    if: needs.detect-changes.outputs.playwright-server-changed == 'true'
    outputs:
      playwright-url: ${{ steps.get-url.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Deploy Playwright Server
        run: ./infrastructure/scripts/deploy-playwright-server.sh ${{ github.sha }}

      - name: Get service URL
        id: get-url
        run: |
          URL=$(cat /tmp/playwright-server-url.txt)
          echo "url=${URL}" >> $GITHUB_OUTPUT

  # ==================== Step 3: Deploy Sites to Firebase Hosting ====================
  deploy-fellspiral:
    name: Deploy Fellspiral (Preview)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [detect-changes, local-tests]
    if: |
      always() &&
      needs.detect-changes.outputs.fellspiral-changed == 'true' &&
      (needs.local-tests.result == 'success' || needs.local-tests.result == 'skipped')
    outputs:
      service-url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            */*/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm install

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Cache Firebase CLI
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-firebase-cli
          restore-keys: |
            ${{ runner.os }}-firebase-cli

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy to Firebase Hosting Preview
        id: deploy
        run: |
          ./infrastructure/scripts/deploy-firebase-hosting.sh fellspiral ${{ github.ref_name }} ${{ github.sha }}
          URL=$(cat /tmp/deployment-url.txt)
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "Deployed to: ${URL}"

  deploy-videobrowser:
    name: Deploy Videobrowser (Preview)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [detect-changes, local-tests]
    if: |
      always() &&
      needs.detect-changes.outputs.videobrowser-changed == 'true' &&
      (needs.local-tests.result == 'success' || needs.local-tests.result == 'skipped')
    outputs:
      service-url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            */*/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm install

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Cache Firebase CLI
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-firebase-cli
          restore-keys: |
            ${{ runner.os }}-firebase-cli

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy to Firebase Hosting Preview
        id: deploy
        run: |
          ./infrastructure/scripts/deploy-firebase-hosting.sh videobrowser ${{ github.ref_name }} ${{ github.sha }}
          URL=$(cat /tmp/deployment-url.txt)
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "Deployed to: ${URL}"

  deploy-audiobrowser:
    name: Deploy Audiobrowser (Preview)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [detect-changes, local-tests]
    if: |
      always() &&
      needs.detect-changes.outputs.audiobrowser-changed == 'true' &&
      (needs.local-tests.result == 'success' || needs.local-tests.result == 'skipped')
    outputs:
      service-url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            */*/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm install

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Cache Firebase CLI
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-firebase-cli
          restore-keys: |
            ${{ runner.os }}-firebase-cli

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy to Firebase Hosting Preview
        id: deploy
        run: |
          ./infrastructure/scripts/deploy-firebase-hosting.sh audiobrowser ${{ github.ref_name }} ${{ github.sha }}
          URL=$(cat /tmp/deployment-url.txt)
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "Deployed to: ${URL}"

  deploy-print:
    name: Deploy Print (Preview)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: local-tests
    if: needs.local-tests.outputs.print-changed == 'true'
    outputs:
      service-url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Initialize rml-media bucket
        continue-on-error: true
        run: |
          echo "Ensuring rml-media bucket is linked to Firebase Storage..."
          ACCESS_TOKEN=$(gcloud auth print-access-token)
          BUCKET_NAME="rml-media"

          # Try to link bucket to Firebase Storage (idempotent - safe to run multiple times)
          LINK_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"bucket\": \"projects/${{ env.GCP_PROJECT_ID }}/buckets/${BUCKET_NAME}\"}" \
            "https://firebasestorage.googleapis.com/v1beta/projects/${{ env.GCP_PROJECT_ID }}/buckets/${BUCKET_NAME}:addFirebase")

          if echo "$LINK_RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            ERROR_STATUS=$(echo "$LINK_RESPONSE" | jq -r '.error.status // empty')
            if [ "$ERROR_STATUS" = "ALREADY_EXISTS" ] || echo "$LINK_RESPONSE" | grep -qi "already"; then
              echo "âœ“ Bucket already linked to Firebase Storage"
            else
              echo "âš ï¸  Could not link bucket (may already be linked or require manual setup)"
              echo "Response: $LINK_RESPONSE"
            fi
          else
            echo "âœ“ Bucket successfully linked to Firebase Storage"
          fi

      - name: Configure CORS for rml-media bucket
        continue-on-error: true
        run: |
          echo "Configuring CORS for rml-media bucket..."
          ACCESS_TOKEN=$(gcloud auth print-access-token)
          BUCKET_NAME="rml-media"

          # Configure CORS to allow web access from any origin
          CORS_RESPONSE=$(curl -s -X PATCH \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{
              "cors": [
                {
                  "origin": ["*"],
                  "method": ["GET", "HEAD", "PUT", "POST", "DELETE"],
                  "responseHeader": ["Content-Type", "Authorization", "x-goog-resumable"],
                  "maxAgeSeconds": 3600
                }
              ]
            }' \
            "https://storage.googleapis.com/storage/v1/b/${BUCKET_NAME}")

          if echo "$CORS_RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            echo "âš ï¸  Could not configure CORS"
            echo "Response: $CORS_RESPONSE"
          else
            echo "âœ“ CORS configured successfully"
          fi

      - name: Configure public access for rml-media bucket
        continue-on-error: true
        run: |
          echo "Configuring public access for rml-media bucket (shared by videobrowser and print)..."
          ACCESS_TOKEN=$(gcloud auth print-access-token)
          BUCKET_NAME="rml-media"

          # Non-default buckets can't use Firebase Storage security rules
          # Instead, we disable public access prevention and use IAM policies

          # Step 1: Disable public access prevention
          echo "Disabling public access prevention..."
          PAP_RESPONSE=$(curl -s -X PATCH \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"iamConfiguration": {"publicAccessPrevention": "inherited"}}' \
            "https://storage.googleapis.com/storage/v1/b/${BUCKET_NAME}")

          if echo "$PAP_RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            echo "âš ï¸  Could not disable public access prevention"
            echo "Response: $PAP_RESPONSE"
          else
            echo "âœ“ Public access prevention disabled (set to inherited)"
          fi

          # Step 2: Grant public read access via IAM
          echo "Granting public read access via IAM..."

          # Get current IAM policy
          IAM_POLICY=$(curl -s -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            "https://storage.googleapis.com/storage/v1/b/${BUCKET_NAME}/iam")

          # Add allUsers objectViewer binding if not already present
          UPDATED_POLICY=$(echo "$IAM_POLICY" | jq '
            .bindings |= (
              if any(.role == "roles/storage.objectViewer" and (.members // [] | contains(["allUsers"]))) then
                .
              else
                . + [{
                  "role": "roles/storage.objectViewer",
                  "members": ["allUsers"]
                }]
              end
            )
          ')

          IAM_RESPONSE=$(curl -s -X PUT \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$UPDATED_POLICY" \
            "https://storage.googleapis.com/storage/v1/b/${BUCKET_NAME}/iam")

          if echo "$IAM_RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            echo "âš ï¸  Could not grant public read access"
            echo "Response: $IAM_RESPONSE"
          else
            echo "âœ“ Public read access granted via IAM (allUsers can read objects)"
          fi

          echo "âœ“ rml-media bucket configured for public read access"

      - name: Deploy to Firebase Hosting Preview
        id: deploy
        run: |
          ./infrastructure/scripts/deploy-firebase-hosting.sh print ${{ github.ref_name }} ${{ github.sha }}
          URL=$(cat /tmp/deployment-url.txt)
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "Deployed to: ${URL}"

  # ==================== Step 4: E2E Tests ====================
  playwright-tests-fellspiral:
    name: E2E Tests - Fellspiral
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [deploy-fellspiral, deploy-playwright-server]
    if: |
      always() &&
      needs.deploy-fellspiral.result == 'success' &&
      (needs.deploy-playwright-server.result == 'success' || needs.deploy-playwright-server.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            */*/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm install

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Playwright server URL
        id: get-playwright-url
        run: |
          if [ "${{ needs.deploy-playwright-server.result }}" = "success" ]; then
            URL="${{ needs.deploy-playwright-server.outputs.playwright-url }}"
          else
            URL=$(gcloud run services describe playwright-server \
              --region=${{ env.GCP_REGION }} \
              --format='value(status.url)')
          fi
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Run Playwright tests
        run: ./infrastructure/scripts/run-playwright-tests.sh fellspiral "${{ needs.deploy-fellspiral.outputs.service-url }}" "${{ steps.get-playwright-url.outputs.url }}"
        env:
          PLAYWRIGHT_SERVER_URL: ${{ steps.get-playwright-url.outputs.url }}
          DEPLOYED_URL: ${{ needs.deploy-fellspiral.outputs.service-url }}
          CI: true

  playwright-tests-videobrowser:
    name: E2E Tests - Videobrowser
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [deploy-videobrowser, deploy-playwright-server]
    if: |
      always() &&
      needs.deploy-videobrowser.result == 'success' &&
      (needs.deploy-playwright-server.result == 'success' || needs.deploy-playwright-server.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            */*/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm install

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Playwright server URL
        id: get-playwright-url
        run: |
          if [ "${{ needs.deploy-playwright-server.result }}" = "success" ]; then
            URL="${{ needs.deploy-playwright-server.outputs.playwright-url }}"
          else
            URL=$(gcloud run services describe playwright-server \
              --region=${{ env.GCP_REGION }} \
              --format='value(status.url)')
          fi
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Run Playwright tests
        run: ./infrastructure/scripts/run-playwright-tests.sh videobrowser "${{ needs.deploy-videobrowser.outputs.service-url }}" "${{ steps.get-playwright-url.outputs.url }}"
        env:
          PLAYWRIGHT_SERVER_URL: ${{ steps.get-playwright-url.outputs.url }}
          DEPLOYED_URL: ${{ needs.deploy-videobrowser.outputs.service-url }}
          CI: true

  playwright-tests-audiobrowser:
    name: E2E Tests - Audiobrowser
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [deploy-audiobrowser, deploy-playwright-server]
    if: |
      always() &&
      needs.deploy-audiobrowser.result == 'success' &&
      (needs.deploy-playwright-server.result == 'success' || needs.deploy-playwright-server.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            */*/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm install

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Playwright server URL
        id: get-playwright-url
        run: |
          if [ "${{ needs.deploy-playwright-server.result }}" = "success" ]; then
            URL="${{ needs.deploy-playwright-server.outputs.playwright-url }}"
          else
            URL=$(gcloud run services describe playwright-server \
              --region=${{ env.GCP_REGION }} \
              --format='value(status.url)')
          fi
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Run Playwright tests
        run: ./infrastructure/scripts/run-playwright-tests.sh audiobrowser "${{ needs.deploy-audiobrowser.outputs.service-url }}" "${{ steps.get-playwright-url.outputs.url }}"
        env:
          PLAYWRIGHT_SERVER_URL: ${{ steps.get-playwright-url.outputs.url }}
          DEPLOYED_URL: ${{ needs.deploy-audiobrowser.outputs.service-url }}
          CI: true

  playwright-tests-print:
    name: Playwright Tests - Print
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [deploy-print, deploy-playwright-server]
    # Run only if print was deployed successfully
    if: |
      always() &&
      needs.deploy-print.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Playwright server URL
        id: playwright-server
        run: |
          # Use deployed URL if available, otherwise get the production URL
          if [ -n "${{ needs.deploy-playwright-server.outputs.playwright-url }}" ]; then
            URL="${{ needs.deploy-playwright-server.outputs.playwright-url }}"
          else
            URL=$(gcloud run services describe playwright-server \
              --platform managed \
              --region ${{ env.GCP_REGION }} \
              --format 'value(status.url)')
          fi
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "Playwright Server URL: ${URL}"

      - name: Test Print
        run: ./infrastructure/scripts/run-playwright-tests.sh print "${{ needs.deploy-print.outputs.service-url }}" "${{ steps.playwright-server.outputs.url }}"
        env:
          PLAYWRIGHT_SERVER_URL: ${{ steps.playwright-server.outputs.url }}
          DEPLOYED_URL: ${{ needs.deploy-print.outputs.service-url }}
          CI: true

  # ==================== Summary ====================
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [local-tests, deploy-fellspiral, deploy-videobrowser, deploy-audiobrowser, deploy-print, playwright-tests-fellspiral, playwright-tests-videobrowser, playwright-tests-audiobrowser, playwright-tests-print]
    if: always()

    steps:
      - name: Create summary
        run: |
          echo "# ðŸš€ Feature Branch Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployments (Firebase Hosting Previews)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy-fellspiral.result }}" = "success" ]; then
            echo "- âœ… **Fellspiral**: ${{ needs.deploy-fellspiral.outputs.service-url }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.deploy-videobrowser.result }}" = "success" ]; then
            echo "- âœ… **Videobrowser**: ${{ needs.deploy-videobrowser.outputs.service-url }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.deploy-audiobrowser.result }}" = "success" ]; then
            echo "- âœ… **Audiobrowser**: ${{ needs.deploy-audiobrowser.outputs.service-url }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.deploy-print.result }}" = "success" ]; then
            echo "- âœ… **Print**: ${{ needs.deploy-print.outputs.service-url }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Local Tests: ${{ needs.local-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Fellspiral E2E: ${{ needs.playwright-tests-fellspiral.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Videobrowser E2E: ${{ needs.playwright-tests-videobrowser.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Audiobrowser E2E: ${{ needs.playwright-tests-audiobrowser.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Print E2E: ${{ needs.playwright-tests-print.result }}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”¥ **Firebase Hosting**: All deployments use Firebase Hosting with automatic auth authorization" >> $GITHUB_STEP_SUMMARY
          echo "â° **Preview expiration**: 7 days from deployment" >> $GITHUB_STEP_SUMMARY
