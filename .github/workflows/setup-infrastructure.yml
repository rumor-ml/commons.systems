name: Setup Infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'apply'
        type: choice
        options:
          - apply
          - destroy
          - plan

env:
  TF_VERSION: '1.6.0'
  WORKING_DIR: infrastructure/terraform

jobs:
  terraform:
    name: Terraform ${{ github.event.inputs.action }}
    runs-on: ubuntu-latest
    timeout-minutes: 30

    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Create terraform.tfvars
        run: |
          cat > terraform.tfvars <<EOF
          project_id  = "${{ secrets.GCP_PROJECT_ID }}"
          region      = "us-central1"
          environment = "production"
          EOF

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        id: plan
        run: terraform plan -out=tfplan
        continue-on-error: false

      - name: Terraform Apply
        if: github.event.inputs.action == 'apply'
        run: terraform apply -auto-approve tfplan

      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        run: terraform destroy -auto-approve

      - name: Get Infrastructure Outputs
        if: github.event.inputs.action == 'apply'
        id: outputs
        run: |
          echo "bucket_name=$(terraform output -raw bucket_name)" >> $GITHUB_OUTPUT
          echo "site_ip=$(terraform output -raw site_ip)" >> $GITHUB_OUTPUT
          echo "site_url=$(terraform output -raw site_url)" >> $GITHUB_OUTPUT

      - name: Create service account for deployments
        if: github.event.inputs.action == 'apply'
        run: |
          PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}"
          SA_NAME="github-actions-deployer"
          SA_EMAIL="${SA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com"

          # Create service account if it doesn't exist
          if ! gcloud iam service-accounts describe "$SA_EMAIL" 2>/dev/null; then
            gcloud iam service-accounts create "$SA_NAME" \
              --display-name="GitHub Actions Deployer"
            echo "Service account created"
          else
            echo "Service account already exists"
          fi

          # Grant permissions
          gcloud projects add-iam-policy-binding "$PROJECT_ID" \
            --member="serviceAccount:${SA_EMAIL}" \
            --role="roles/storage.admin" \
            --condition=None || true

          gcloud projects add-iam-policy-binding "$PROJECT_ID" \
            --member="serviceAccount:${SA_EMAIL}" \
            --role="roles/compute.loadBalancerAdmin" \
            --condition=None || true

          echo "Permissions granted"

          # Note: Key creation should be done manually for security
          echo "::notice::Service account created. If you need to rotate keys, create a new key manually."

      - name: Comment on commit
        if: github.event.inputs.action == 'apply' && steps.outputs.outputs.site_url != ''
        uses: actions/github-script@v7
        with:
          script: |
            const output = `## Infrastructure Setup Complete! ðŸš€

            **Infrastructure Details:**
            - Bucket: \`${{ steps.outputs.outputs.bucket_name }}\`
            - Static IP: \`${{ steps.outputs.outputs.site_ip }}\`
            - Site URL: ${{ steps.outputs.outputs.site_url }}

            **Next Steps:**
            1. âœ… Infrastructure is ready
            2. âœ… Service account configured
            3. ðŸ”„ Merge your PR to deploy the site!

            **Cost:** ~$0.13/month for typical traffic

            ---
            *Automated infrastructure setup via Terraform*`;

            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: output
            });

      - name: Summary
        if: github.event.inputs.action == 'apply'
        run: |
          echo "### Infrastructure Setup Complete! âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Bucket:** ${{ steps.outputs.outputs.bucket_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Static IP:** ${{ steps.outputs.outputs.site_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "**Site URL:** ${{ steps.outputs.outputs.site_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Merge your PR to deploy!" >> $GITHUB_STEP_SUMMARY
