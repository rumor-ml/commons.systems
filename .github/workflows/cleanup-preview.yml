name: Cleanup Feature Branch Preview

on:
  delete:
    branches:
      - '**'
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name to clean up (optional - auto-detected on delete)'
        required: false
        type: string

env:
  GCP_PROJECT_ID: chalanding
  GCP_REGION: us-central1

jobs:
  cleanup:
    name: Delete Preview Services
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Determine branch name
        id: branch
        run: |
          if [ "${{ github.event_name }}" = "delete" ]; then
            BRANCH_NAME="${{ github.event.ref }}"
          elif [ -n "${{ inputs.branch_name }}" ]; then
            BRANCH_NAME="${{ inputs.branch_name }}"
          else
            echo "Error: Could not determine branch name"
            exit 1
          fi

          echo "branch=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "Cleaning up branch: ${BRANCH_NAME}"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/190604485916/locations/global/workloadIdentityPools/github-actions/providers/github'
          service_account: 'github-actions-terraform@chalanding.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Firebase CLI
        run: pnpm add -g firebase-tools

      - name: Delete Firebase Hosting preview channels
        continue-on-error: true
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.branch }}"

          # Sanitize branch name for Firebase channel (same logic as deployment)
          CHANNEL_NAME=$(echo "$BRANCH_NAME" | \
            tr '[:upper:]' '[:lower:]' | \
            sed 's/[^a-z0-9-]/-/g' | \
            sed 's/-\+/-/g' | \
            sed 's/^-//' | \
            sed 's/-$//' | \
            cut -c1-63)

          echo "ðŸ§¹ Cleaning up Firebase Hosting preview channels"
          echo "Branch: ${{ steps.branch.outputs.branch }}"
          echo "Channel: ${CHANNEL_NAME}"

          # Sites to clean up
          SITES=("fellspiral" "videobrowser" "audiobrowser")
          DELETED_COUNT=0

          for site in "${SITES[@]}"; do
            echo ""
            echo "Checking ${site} for channel ${CHANNEL_NAME}..."

            # Try to delete the channel
            if firebase hosting:channel:delete "$CHANNEL_NAME" \
              --site ${site} \
              --project ${{ env.GCP_PROJECT_ID }} \
              --force 2>&1; then
              echo "âœ… Deleted preview channel for ${site}"
              DELETED_COUNT=$((DELETED_COUNT + 1))
            else
              echo "â„¹ï¸  No preview channel found for ${site} (or already deleted)"
            fi
          done

          echo ""
          echo "### ðŸ§¹ Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ steps.branch.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Channel:** ${CHANNEL_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "**Preview channels deleted:** ${DELETED_COUNT}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Firebase Hosting preview channels are automatically cleaned up after expiration (7 days)." >> $GITHUB_STEP_SUMMARY

      - name: Delete Artifact Registry packages for branch
        continue-on-error: true
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.branch }}"

          # Skip main branch
          if [ "$BRANCH_NAME" = "main" ]; then
            echo "Skipping cleanup for main branch"
            exit 0
          fi

          # Sanitize branch name
          SANITIZED=$(echo "$BRANCH_NAME" | sed 's|^claude/||' | tr '[:upper:]' '[:lower:]' | tr '/_' '-' | sed 's/[^a-z0-9-]//g' | cut -c1-63 | sed 's/-$//')

          echo "Cleaning up packages for: $SANITIZED"

          # Delete from site preview repos
          for site in fellspiral videobrowser audiobrowser print; do
            PACKAGE="${site}-${SANITIZED}"
            gcloud artifacts packages delete "$PACKAGE" \
              --repository="${site}-previews" \
              --location=${{ env.GCP_REGION }} \
              --project=${{ env.GCP_PROJECT_ID }} \
              --quiet 2>/dev/null && echo "Deleted: $PACKAGE" || echo "Not found: $PACKAGE"
          done
