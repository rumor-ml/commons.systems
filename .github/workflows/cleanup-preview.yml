name: Cleanup Feature Branch Preview

on:
  delete:
    branches:
      - '**'
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name to clean up (optional - auto-detected on delete)'
        required: false
        type: string

env:
  GCP_PROJECT_ID: chalanding
  GCP_REGION: us-central1

jobs:
  cleanup:
    name: Delete Preview Services
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Determine branch name
        id: branch
        run: |
          if [ "${{ github.event_name }}" = "delete" ]; then
            BRANCH_NAME="${{ github.event.ref }}"
          elif [ -n "${{ inputs.branch_name }}" ]; then
            BRANCH_NAME="${{ inputs.branch_name }}"
          else
            echo "Error: Could not determine branch name"
            exit 1
          fi

          echo "branch=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "Cleaning up branch: ${BRANCH_NAME}"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/190604485916/locations/global/workloadIdentityPools/github-actions/providers/github'
          service_account: 'github-actions-terraform@chalanding.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Find and delete preview services (all sites)
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.branch }}"

          # Sanitize branch name (same logic as deployment)
          BRANCH_NAME="${BRANCH_NAME#claude/}"
          SANITIZED=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | tr '/_' '-' | sed 's/[^a-z0-9-]//g')

          echo "Looking for services matching patterns:"
          echo "  - fellspiral-${SANITIZED} (current)"
          echo "  - videobrowser-${SANITIZED} (current)"
          echo "  - fellspiral-${SANITIZED}-* (legacy with SHA)"
          echo "  - videobrowser-${SANITIZED}-* (legacy with SHA)"
          echo "  - fb-${SANITIZED}-* (legacy abbreviated)"
          echo "  - vb-${SANITIZED}-* (legacy abbreviated)"

          # List all Cloud Run services with preview label
          SERVICES=$(gcloud run services list \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --format='value(metadata.name)' \
            --filter="metadata.labels.preview=true" 2>/dev/null || echo "")

          if [ -z "$SERVICES" ]; then
            echo "No preview services found to clean up"
            exit 0
          fi

          # Filter services matching this branch (current naming, legacy with SHA, legacy abbreviated)
          DELETED_COUNT=0
          while IFS= read -r service; do
            if [[ "$service" == "fellspiral-${SANITIZED}" ]] || \
               [[ "$service" == "videobrowser-${SANITIZED}" ]] || \
               [[ "$service" == fellspiral-${SANITIZED}-* ]] || \
               [[ "$service" == videobrowser-${SANITIZED}-* ]] || \
               [[ "$service" == fb-${SANITIZED}-* ]] || \
               [[ "$service" == vb-${SANITIZED}-* ]]; then
              echo "Deleting service: $service"
              gcloud run services delete "$service" \
                --region=${{ env.GCP_REGION }} \
                --project=${{ env.GCP_PROJECT_ID }} \
                --quiet || echo "Failed to delete $service (may already be deleted)"
              DELETED_COUNT=$((DELETED_COUNT + 1))
            fi
          done <<< "$SERVICES"

          echo "### ðŸ§¹ Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ steps.branch.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Services deleted:** ${DELETED_COUNT}" >> $GITHUB_STEP_SUMMARY

      - name: Clean up fellspiral images (optional)
        continue-on-error: true
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.branch }}"
          BRANCH_NAME="${BRANCH_NAME#claude/}"
          SANITIZED=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | tr '/_' '-' | sed 's/[^a-z0-9-]//g')

          echo "Cleaning up fellspiral images for fellspiral-${SANITIZED} and legacy patterns"

          # List all images in the repository
          IMAGES=$(gcloud artifacts docker images list \
            "${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/fellspiral-previews" \
            --format='value(package)' 2>/dev/null || echo "")

          if [ -z "$IMAGES" ]; then
            echo "No fellspiral images found to clean up"
            return 0
          fi

          # Delete images matching current naming or legacy patterns
          echo "$IMAGES" | while read -r package; do
            # Extract just the image name from the full package path
            IMAGE_NAME=$(basename "$package")
            if [[ "$IMAGE_NAME" == "fellspiral-${SANITIZED}" ]] || \
               [[ "$IMAGE_NAME" == fellspiral-${SANITIZED}-* ]] || \
               [[ "$IMAGE_NAME" == fb-${SANITIZED}-* ]]; then
              echo "Deleting fellspiral image: $package"
              gcloud artifacts docker images delete "$package" \
                --delete-tags \
                --quiet 2>/dev/null || true
            fi
          done

          echo "Fellspiral image cleanup completed (best effort)"

      - name: Clean up videobrowser images (optional)
        continue-on-error: true
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.branch }}"
          BRANCH_NAME="${BRANCH_NAME#claude/}"
          SANITIZED=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | tr '/_' '-' | sed 's/[^a-z0-9-]//g')

          echo "Cleaning up videobrowser images for videobrowser-${SANITIZED} and legacy patterns"

          # List all images in the repository
          IMAGES=$(gcloud artifacts docker images list \
            "${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/videobrowser-previews" \
            --format='value(package)' 2>/dev/null || echo "")

          if [ -z "$IMAGES" ]; then
            echo "No videobrowser images found to clean up"
            return 0
          fi

          # Delete images matching current naming or legacy patterns
          echo "$IMAGES" | while read -r package; do
            # Extract just the image name from the full package path
            IMAGE_NAME=$(basename "$package")
            if [[ "$IMAGE_NAME" == "videobrowser-${SANITIZED}" ]] || \
               [[ "$IMAGE_NAME" == videobrowser-${SANITIZED}-* ]] || \
               [[ "$IMAGE_NAME" == vb-${SANITIZED}-* ]]; then
              echo "Deleting videobrowser image: $package"
              gcloud artifacts docker images delete "$package" \
                --delete-tags \
                --quiet 2>/dev/null || true
            fi
          done

          echo "Videobrowser image cleanup completed (best effort)"
