# SSH Public Keys Repository

This directory contains public SSH keys for all machines and users in the infrastructure.

**IMPORTANT:** Only public keys (`.pub` files) should be stored here. Never commit private keys!

## Directory Structure

```
ssh-keys/
├── machines/        # Public keys for each machine
│   ├── wsl-nix.pub  # WSL2 NixOS machine
│   ├── laptop.pub   # Your laptop
│   └── desktop.pub  # Your desktop
└── users/           # Public keys for users/services
    └── n8.pub       # Main user key
```

## Usage

### Adding a New Machine

When setting up a new machine:

1. **Generate or locate the public key** on the new machine:

   ```bash
   # Public key is auto-generated by Home Manager, or generate manually:
   ssh-keygen -t ed25519 -C "$(whoami)@$(hostname)"

   # View the public key
   cat ~/.ssh/id_ed25519.pub
   ```

2. **Add to this repository:**

   ```bash
   # Copy the public key content to a new file
   echo "ssh-ed25519 AAAAC3... user@hostname" > nix/ssh-keys/machines/newmachine.pub

   # Or copy directly
   scp user@newmachine:~/.ssh/id_ed25519.pub nix/ssh-keys/machines/newmachine.pub
   ```

3. **Update the authorized keys module:**
   Edit `nix/home/ssh-authorized-keys.nix` and add the new machine to the list:

   ```nix
   machineKeys = builtins.map builtins.readFile [
     "${sshKeysDir}/machines/wsl-nix.pub"
     "${sshKeysDir}/machines/newmachine.pub"  # Add this line
   ];
   ```

4. **Commit and deploy:**

   ```bash
   git add nix/ssh-keys/machines/newmachine.pub
   git add nix/home/ssh-authorized-keys.nix
   git commit -m "Add SSH key for newmachine"
   git push

   # On ALL machines, run:
   home-manager switch --flake .#x86_64-linux
   ```

Now all machines can SSH to each other!

### Adding a User Key

For a user's personal key (used across multiple machines):

```bash
# Add the key
echo "ssh-ed25519 AAAAC3... n8@personal" > nix/ssh-keys/users/n8.pub

# It will automatically be included (see ssh-authorized-keys.nix)
```

### Removing Access

To revoke a machine's access:

1. **Remove the public key file:**

   ```bash
   git rm nix/ssh-keys/machines/oldmachine.pub
   ```

2. **Remove from authorized keys module:**
   Edit `nix/home/ssh-authorized-keys.nix` and remove the line

3. **Commit and deploy:**

   ```bash
   git commit -m "Revoke access for oldmachine"
   git push

   # On all machines:
   home-manager switch --flake .#x86_64-linux
   ```

## Current Keys

### Machines

- `wsl-nix.pub` - Primary WSL2 NixOS development environment

### Users

- (None yet - add your personal keys here)

## Security Notes

✅ **Safe to commit:** Public keys (`.pub` files)
❌ **NEVER commit:** Private keys (files without `.pub` extension)

Public keys are designed to be shared. They can only be used to verify identity, not to impersonate you.

## Verification

To see which keys are currently authorized on a machine:

```bash
cat ~/.ssh/authorized_keys
```

To test SSH access:

```bash
# From one machine to another
ssh user@othermachine

# With verbose output for debugging
ssh -vvv user@othermachine
```

## Automation

The keys in this directory are automatically distributed to all machines via the `nix/home/ssh-authorized-keys.nix` Home Manager module.

When you run `home-manager switch`, it:

1. Reads all keys from `nix/ssh-keys/`
2. Generates `~/.ssh/authorized_keys` with all keys
3. Sets correct permissions (600)

No manual key copying needed!
