#!/bin/bash

# Wrapper for making authenticated GCP API requests
# Usage: gcpcurl <url> [curl options...]
# Example: gcpcurl https://storage.googleapis.com/storage/v1/b/rml-media

if [ -z "$1" ]; then
    echo "Usage: gcpcurl <url> [curl options...]" >&2
    echo "" >&2
    echo "Examples:" >&2
    echo "  gcpcurl https://storage.googleapis.com/storage/v1/b/rml-media" >&2
    echo "  gcpcurl https://run.googleapis.com/v2/projects/chalanding/locations/us-central1/services" >&2
    exit 1
fi

URL="$1"
shift  # Remove URL from args, rest are curl options

# Get token (suppress all stderr output)
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/get_gcp_token.sh" 2>/dev/null || {
    # If sourcing failed, try again with errors visible
    echo "Error getting GCP token:" >&2
    source "$SCRIPT_DIR/get_gcp_token.sh"
    exit 1
}

# Verify token is set
if [ -z "$GCP_ACCESS_TOKEN" ] || [ "$GCP_ACCESS_TOKEN" = "null" ]; then
    echo "Error: GCP_ACCESS_TOKEN not set" >&2
    exit 1
fi

# Make the request
exec curl -s -H "Authorization: Bearer $GCP_ACCESS_TOKEN" "$@" "$URL"
