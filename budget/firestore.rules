rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthenticated() { return request.auth != null; }
    function isOwner(userId) { return request.auth.uid == userId; }

    // Budget Transactions - user can read/write their own transactions
    match /budget-transactions/{transactionId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.createdAt == request.time;
      allow update: if isAuthenticated() && isOwner(resource.data.userId)
                    && request.resource.data.userId == resource.data.userId;
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Budget Statements - user can read/write their own statements
    match /budget-statements/{statementId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.createdAt == request.time;
      allow update: if isAuthenticated() && isOwner(resource.data.userId)
                    && request.resource.data.userId == resource.data.userId;
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Budget Accounts - user can read/write their own accounts
    match /budget-accounts/{accountId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.createdAt == request.time;
      allow update: if isAuthenticated() && isOwner(resource.data.userId)
                    && request.resource.data.userId == resource.data.userId;
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Budget Institutions - user can read/write their own institutions
    match /budget-institutions/{institutionId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.createdAt == request.time;
      allow update: if isAuthenticated() && isOwner(resource.data.userId)
                    && request.resource.data.userId == resource.data.userId;
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Budget Parse Sessions - user can read/write their own parse sessions
    match /budget-parse-sessions/{sessionId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.createdAt == request.time;
      allow update: if isAuthenticated() && isOwner(resource.data.userId)
                    && request.resource.data.userId == resource.data.userId;
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Budget Demo Transactions - publicly readable, user-owned writes
    // Matches: budget-demo-transactions, budget-demo-transactions-worker-0,
    //          budget-demo-transactions_pr_123, budget-demo-transactions_preview_branch
    match /budget-demo-transactions{suffix}/{transactionId} {
      allow read: if true; // Publicly readable demo data
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.createdAt == request.time;
      allow update: if isAuthenticated() && isOwner(resource.data.userId)
                    && request.resource.data.userId == resource.data.userId;
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Budget Demo Statements - publicly readable, user-owned writes
    match /budget-demo-statements{suffix}/{statementId} {
      allow read: if true; // Publicly readable demo data
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.createdAt == request.time;
      allow update: if isAuthenticated() && isOwner(resource.data.userId)
                    && request.resource.data.userId == resource.data.userId;
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Budget Demo Accounts - publicly readable, user-owned writes
    match /budget-demo-accounts{suffix}/{accountId} {
      allow read: if true; // Publicly readable demo data
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.createdAt == request.time;
      allow update: if isAuthenticated() && isOwner(resource.data.userId)
                    && request.resource.data.userId == resource.data.userId;
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Budget Demo Institutions - publicly readable, user-owned writes
    match /budget-demo-institutions{suffix}/{institutionId} {
      allow read: if true; // Publicly readable demo data
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.createdAt == request.time;
      allow update: if isAuthenticated() && isOwner(resource.data.userId)
                    && request.resource.data.userId == resource.data.userId;
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Deny all other access
    match /{document=**} { allow read, write: if false; }
  }
}
